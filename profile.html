<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البيانات الشخصية - اليوم العلمي</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* [Previous CSS styles remain the same as in your provided code] */
        [Your existing CSS here]
    </style>
</head>
<body>
    <header class="header">
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            تسجيل الخروج
        </button>
        <div class="logo-container">
            <img src="شعار الجامع.png" alt="شعار الجامع" class="logo">
            <img src="شعار جمعية اثر الجديد بدون خلفية.png" alt="شعار الجمعية" class="logo">
        </div>
    </header>

    <div class="container">
        <div class="profile-card">
            <div class="welcome-banner">
                <h2><i class="fas fa-user-circle"></i> حياك الله، <span id="welcomeName">-</span></h2>
                <p>سعدنا بوجودك معنا في اليوم العلمي</p>
            </div>

            <div class="info-group">
                <h3><i class="fas fa-info-circle"></i> معلومات المستخدم</h3>
                <div class="info-item">
                    <span><i class="fas fa-user"></i> الاسم:</span>
                    <span id="userName">-</span>
                </div>
                <div class="info-item">
                    <span><i class="fas fa-envelope"></i> البريد الإلكتروني:</span>
                    <span id="userEmail">-</span>
                </div>
                <div class="info-item">
                    <span><i class="fas fa-phone"></i> رقم الجوال:</span>
                    <span id="userPhone">-</span>
                </div>
                <div class="info-item">
                    <span><i class="fas fa-venus-mars"></i> الجنس:</span>
                    <span id="userGender">-</span>
                </div>
                <div class="info-item">
                    <span><i class="fas fa-user-tag"></i> نوع المشاركة:</span>
                    <span id="userType">-</span>
                </div>
                <div class="info-item">
                    <span><i class="fas fa-globe"></i> الدولة:</span>
                    <span id="userCountry">-</span>
                </div>
            </div>

            <div id="attendanceStatus" class="attendance-status">
                <i class="fas fa-check-circle"></i> تم تسجيل حضورك بنجاح!
            </div>

            <div class="button-group">
                <button id="attendanceBtn" class="button" onclick="markAttendance()">
                    <i class="fas fa-clipboard-check"></i>
                    تسجيل الحضور
                </button>
                <button id="certificateBtn" class="button" onclick="getCertificate()" disabled>
                    <i class="fas fa-certificate"></i>
                    تحميل الشهادة
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwUW_7YEmUAOUt8RUy8o3lSvYNv5WgWyyFYLVlsTFKpSe_GDk8Peh9C5j5P1N_zFhZA/exec';
        let userData;

        window.onload = function() {
            const userDataString = localStorage.getItem('userData');
            console.log('Loaded user data:', userDataString);

            if (!userDataString) {
                console.log('No user data found, redirecting to login...');
                window.location.href = 'login.html';
                return;
            }

            try {
                userData = JSON.parse(userDataString);
                if (!userData || !userData.email) {
                    throw new Error('Invalid user data');
                }
                console.log('User data parsed successfully:', userData);
                displayUserData();
                updateButtons();
            } catch (error) {
                console.error('Error loading user data:', error);
                localStorage.clear();
                window.location.href = 'login.html';
            }
        };

        function displayUserData() {
            document.getElementById('welcomeName').textContent = userData.name?.split(' ')[0] || 'زائرنا الكريم';
            document.getElementById('userName').textContent = userData.name || '-';
            document.getElementById('userEmail').textContent = userData.email || '-';
            document.getElementById('userPhone').textContent = userData.phone || '-';
            document.getElementById('userGender').textContent = userData.gender || '-';
            document.getElementById('userType').textContent = userData.type || '-';
            document.getElementById('userCountry').textContent = userData.country || '-';

            if (userData.attendance) {
                document.getElementById('attendanceStatus').style.display = 'block';
            }
        }

        function updateButtons() {
            const attendanceButton = document.getElementById('attendanceBtn');
            const certificateButton = document.getElementById('certificateBtn');

            if (userData.attendance) {
                attendanceButton.disabled = true;
                attendanceButton.innerHTML = '<i class="fas fa-check"></i> تم تسجيل الحضور';
                certificateButton.disabled = false;
            }
        }

        function showToast(message, isSuccess = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = isSuccess ? '#e8f5e9' : '#ffebee';
            toast.style.color = isSuccess ? '#2e7d32' : '#c62828';
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        async function markAttendance() {
            try {
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', 'markAttendance');
                url.searchParams.append('email', userData.email);
                url.searchParams.append('phone', userData.phone);

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    userData.attendance = true;
                    localStorage.setItem('userData', JSON.stringify(userData));
                    displayUserData();
                    updateButtons();
                    showToast('تم تسجيل حضورك بنجاح!', true);
                } else {
                    throw new Error(data.message || 'حدث خطأ في تسجيل الحضور');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message, false);
            }
        }

        async function getCertificate() {
            try {
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', 'getCertificate');
                url.searchParams.append('email', userData.email);
                url.searchParams.append('phone', userData.phone);

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.certificateLink) {
                    window.open(data.certificateLink, '_blank');
                    showToast('جاري تحميل الشهادة...', true);
                } else {
                    throw new Error(data.message || 'الشهادة غير متوفرة');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message, false);
            }
        }

        function logout() {
            localStorage.removeItem('userData');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
