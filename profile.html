<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الملف الشخصي</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <style>
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        #attendanceStatus {
            display: none;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .card-header {
            background: linear-gradient(45deg, #1a237e, #283593);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        .btn-primary {
            background-color: #1a237e;
            border-color: #1a237e;
        }
        .btn-primary:hover {
            background-color: #283593;
            border-color: #283593;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header text-center">
                <h3>حياك الله معنا</h3>
                <p class="mb-0">سعدنا بوجودك معنا في اليوم العلمي</p>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-12">
                        <h4 class="mb-4">
                            <i class="bi bi-person-circle"></i>
                            معلومات المستخدم
                        </h4>
                        <div class="mb-3">
                            <label class="fw-bold">الاسم:</label>
                            <span id="userName" class="me-2">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">البريد الإلكتروني:</label>
                            <span id="userEmail" class="me-2">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">رقم الجوال:</label>
                            <span id="userPhone" class="me-2">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">الجنس:</label>
                            <span id="userGender" class="me-2">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">نوع المشاركة:</label>
                            <span id="userType" class="me-2">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">الدولة:</label>
                            <span id="userCountry" class="me-2">-</span>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button id="attendanceBtn" class="btn btn-primary" onclick="markAttendance()">تسجيل الحضور</button>
                    <button id="certificateBtn" class="btn btn-success" disabled onclick="downloadCertificate()">تحميل الشهادة</button>
                </div>
                <div id="attendanceStatus" class="alert alert-success mt-3 text-center">
                    ✅ تم تسجيل حضورك بنجاح!
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        async function markAttendance() {
            try {
                const email = localStorage.getItem('userEmail');
                const phone = localStorage.getItem('userPhone');
                
                if (!email || !phone) {
                    showToast('❌ لم يتم العثور على بيانات المستخدم', false);
                    return;
                }

                const url = `https://script.google.com/macros/s/AKfycbwlpjDzPXyNolYKUuRZ440ETb4oPDYPthz62ObC8FSXix7TLv6UGSGmLcBrLYy49Eiy/exec?action=markAttendance&email=${email}&phone=${phone}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('attendanceBtn').disabled = true;
                    document.getElementById('certificateBtn').disabled = false;
                    document.getElementById('attendanceStatus').style.display = 'block';
                    showToast('✅ تم تسجيل حضورك بنجاح!', true);
                    
                    // تحديث البيانات في localStorage
                    const userData = JSON.parse(localStorage.getItem('userData'));
                    userData.attendance = "حاضر";
                    localStorage.setItem('userData', JSON.stringify(userData));
                } else {
                    showToast(data.message || '❌ حدث خطأ في تسجيل الحضور', false);
                }
            } catch (error) {
                console.error('خطأ:', error);
                showToast('❌ حدث خطأ في الاتصال', false);
            }
        }

        window.onload = async function() {
            try {
                const email = localStorage.getItem('userEmail');
                const phone = localStorage.getItem('userPhone');
                
                if (!email || !phone) {
                    window.location.href = 'login.html';
                    return;
                }

                const url = `https://script.google.com/macros/s/AKfycbwlpjDzPXyNolYKUuRZ440ETb4oPDYPthz62ObC8FSXix7TLv6UGSGmLcBrLYy49Eiy/exec?action=verifyUser&email=${email}&phone=${phone}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    const userData = data.data;
                    localStorage.setItem('userData', JSON.stringify(userData));
                    
                    document.getElementById('userName').textContent = userData.name || '-';
                    document.getElementById('userEmail').textContent = userData.email || '-';
                    document.getElementById('userPhone').textContent = userData.phone || '-';
                    document.getElementById('userGender').textContent = userData.gender || '-';
                    document.getElementById('userType').textContent = userData.type || '-';
                    document.getElementById('userCountry').textContent = userData.country || '-';

                    if (userData.attendance === "حاضر") {
                        document.getElementById('attendanceBtn').disabled = true;
                        document.getElementById('certificateBtn').disabled = false;
                        document.getElementById('attendanceStatus').style.display = 'block';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('خطأ:', error);
                showToast('❌ حدث خطأ في تحميل البيانات', false);
            }
        };

        function showToast(message, success = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = success ? '#28a745' : '#dc3545';
            toast.style.color = 'white';
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function downloadCertificate() {
            const userData = JSON.parse(localStorage.getItem('userData'));
            if (userData && userData.certificateLink) {
                window.open(userData.certificateLink, '_blank');
            } else {
                showToast('❌ لم يتم العثور على رابط الشهادة', false);
            }
        }
    </script>
</body>
</html>
