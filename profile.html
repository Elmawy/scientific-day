<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الملف الشخصي</title>
    <!-- إضافة Bootstrap RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <style>
        #toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        #attendanceStatus {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                <h3>حياك الله معنا</h3>
                <p class="mb-0">سعدنا بوجودك معنا في اليوم العلمي</p>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <h4 class="mb-4">
                            <i class="bi bi-info-circle"></i>
                            معلومات المستخدم
                        </h4>
                        <div class="mb-3">
                            <label class="fw-bold">الاسم:</label>
                            <span id="userName">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">البريد الإلكتروني:</label>
                            <span id="userEmail">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">رقم الجوال:</label>
                            <span id="userPhone">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">الجنس:</label>
                            <span id="userGender">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">نوع المشاركة:</label>
                            <span id="userType">-</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">الدولة:</label>
                            <span id="userCountry">-</span>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button id="attendanceBtn" class="btn btn-primary" onclick="markAttendance()">تسجيل الحضور</button>
                    <button id="certificateBtn" class="btn btn-success" disabled>تحميل الشهادة</button>
                </div>
                <div id="attendanceStatus" class="alert alert-success mt-3 text-center">
                    ✅ تم تسجيل حضورك بنجاح!
                </div>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // دالة تسجيل الحضور
        async function markAttendance() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData'));
                if (!userData) {
                    showToast('❌ لم يتم العثور على بيانات المستخدم', false);
                    return;
                }

                const url = `https://script.google.com/macros/s/AKfycbwlpjDzPXyNolYKUuRZ440ETb4oPDYPthz62ObC8FSXix7TLv6UGSGmLcBrLYy49Eiy/exec?action=markAttendance&email=${userData.email}&phone=${userData.phone}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('attendanceBtn').disabled = true;
                    document.getElementById('certificateBtn').disabled = false;
                    document.getElementById('attendanceStatus').style.display = 'block';
                    showToast('✅ تم تسجيل حضورك بنجاح!', true);
                  
                    userData.attendance = "حاضر";
                    localStorage.setItem('userData', JSON.stringify(userData));
                } else {
                    showToast(data.message || '❌ حدث خطأ في تسجيل الحضور', false);
                }
            } catch (error) {
                console.error('خطأ:', error);
                showToast('❌ حدث خطأ في الاتصال', false);
            }
        }

        // دالة تحميل البيانات عند فتح الصفحة
        window.onload = function() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData'));
                if (!userData) {
                    window.location.href = 'login.html';
                    return;
                }

                document.getElementById('userName').textContent = userData.name || '-';
                document.getElementById('userEmail').textContent = userData.email || '-';
                document.getElementById('userPhone').textContent = userData.phone || '-';
                document.getElementById('userGender').textContent = userData.gender || '-';
                document.getElementById('userType').textContent = userData.type || '-';
                document.getElementById('userCountry').textContent = userData.country || '-';

                if (userData.attendance === "حاضر") {
                    document.getElementById('attendanceBtn').disabled = true;
                    document.getElementById('certificateBtn').disabled = false;
                    document.getElementById('attendanceStatus').style.display = 'block';
                }
            } catch (error) {
                console.error('خطأ:', error);
                showToast('❌ حدث خطأ في تحميل البيانات', false);
            }
        };

        // دالة عرض الرسائل
        function showToast(message, success = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = success ? '#28a745' : '#dc3545';
            toast.style.color = 'white';
            toast.style.display = 'block';
          
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
